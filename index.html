<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha ESS Solar Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Animated gradient background */
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        
        /* Glowing effect */
        .glow-green { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
        .glow-yellow { box-shadow: 0 0 20px rgba(234, 179, 8, 0.3); }
        .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .glow-red { box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
        
        /* Power flow animation */
        @keyframes flowRight {
            0% { transform: translateX(-100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        @keyframes flowLeft {
            0% { transform: translateX(100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes flowDown {
            0% { transform: translateY(-100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        @keyframes flowUp {
            0% { transform: translateY(100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-100%); opacity: 0; }
        }
        .flow-right { animation: flowRight 1.5s ease-in-out infinite; }
        .flow-left { animation: flowLeft 1.5s ease-in-out infinite; }
        .flow-down { animation: flowDown 1.5s ease-in-out infinite; }
        .flow-up { animation: flowUp 1.5s ease-in-out infinite; }
        
        /* Pulse animation */
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        /* Card hover effect */
        .card-hover { transition: transform 0.2s, box-shadow 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        
        /* Battery fill animation */
        .battery-fill { transition: height 1s ease-out; }
        
        /* Gauge styling */
        .gauge-container { position: relative; }
        .gauge-bg { stroke: #1e293b; }
        .gauge-fill { transition: stroke-dashoffset 1s ease-out; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    
    <!-- Loading Overlay -->
    <div id="loading" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white/80">Loading solar data...</p>
        </div>
    </div>
    
    <!-- Setup Panel -->
    <div id="setup" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-slate-800/50 backdrop-blur-xl rounded-3xl p-8 max-w-md w-full border border-slate-700/50">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <span class="text-4xl">‚òÄÔ∏è</span>
                </div>
                <h1 class="text-2xl font-bold">Alpha ESS Monitor</h1>
                <p class="text-slate-400 mt-2">Professional Solar Dashboard</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-2">Google Apps Script URL</label>
                    <input type="text" id="scriptUrl" 
                           class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-green-500 focus:ring-1 focus:ring-green-500 transition"
                           placeholder="https://script.google.com/macros/s/.../exec">
                </div>
                
                <button onclick="connect()" 
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold py-3 rounded-xl hover:from-green-600 hover:to-emerald-700 transition transform hover:scale-[1.02]">
                    Connect to System
                </button>
                
                <button onclick="startDemo()" 
                        class="w-full bg-slate-700/50 text-slate-300 py-3 rounded-xl hover:bg-slate-700 transition">
                    Try Demo Mode
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-slate-900/50 backdrop-blur-xl border-b border-slate-700/50 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center">
                            <span class="text-xl">‚òÄÔ∏è</span>
                        </div>
                        <div>
                            <h1 class="font-bold text-lg">Alpha ESS Dashboard</h1>
                            <p class="text-sm text-slate-400" id="systemId">--</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="statusBadge" class="flex items-center gap-2 bg-green-500/20 text-green-400 px-3 py-1.5 rounded-full text-sm">
                            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                            <span>Live</span>
                        </div>
                        <button onclick="loadData()" class="bg-slate-700 hover:bg-slate-600 p-2.5 rounded-xl transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                        <button onclick="location.reload()" class="bg-slate-700 hover:bg-slate-600 p-2.5 rounded-xl transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <!-- Live Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Solar Power -->
                <div class="bg-gradient-to-br from-yellow-500/20 to-orange-500/10 border border-yellow-500/30 rounded-2xl p-4 card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-yellow-400/80 text-sm font-medium">Solar Power</span>
                        <span class="text-2xl">‚òÄÔ∏è</span>
                    </div>
                    <div class="text-3xl font-bold text-yellow-400" id="pvPower">0.00</div>
                    <div class="text-yellow-400/60 text-sm">kW generating</div>
                </div>
                
                <!-- Battery -->
                <div class="bg-gradient-to-br from-green-500/20 to-emerald-500/10 border border-green-500/30 rounded-2xl p-4 card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-green-400/80 text-sm font-medium">Battery</span>
                        <span class="text-2xl">üîã</span>
                    </div>
                    <div class="text-3xl font-bold text-green-400" id="soc">0%</div>
                    <div class="text-green-400/60 text-sm" id="batStatus">--</div>
                </div>
                
                <!-- Grid -->
                <div id="gridCard" class="bg-gradient-to-br from-blue-500/20 to-cyan-500/10 border border-blue-500/30 rounded-2xl p-4 card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-blue-400/80 text-sm font-medium">Grid</span>
                        <span class="text-2xl">‚ö°</span>
                    </div>
                    <div class="text-3xl font-bold text-blue-400" id="gridPower">0.00</div>
                    <div class="text-blue-400/60 text-sm" id="gridStatus">kW</div>
                </div>
                
                <!-- Home Load -->
                <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/10 border border-purple-500/30 rounded-2xl p-4 card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-purple-400/80 text-sm font-medium">Home Load</span>
                        <span class="text-2xl">üè†</span>
                    </div>
                    <div class="text-3xl font-bold text-purple-400" id="loadPower">0.00</div>
                    <div class="text-purple-400/60 text-sm">kW consuming</div>
                </div>
            </div>
            
            <!-- Power Flow Visualization -->
            <div class="bg-slate-800/50 backdrop-blur-xl rounded-3xl p-6 border border-slate-700/50">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                    Live Power Flow
                </h2>
                
                <div class="relative" style="height: 350px;">
                    <!-- SVG Lines Layer -->
                    <svg class="absolute inset-0 w-full h-full" style="z-index: 1;">
                        <!-- Define gradients and markers -->
                        <defs>
                            <!-- Animated flow pattern -->
                            <pattern id="flowPattern" patternUnits="userSpaceOnUse" width="16" height="8">
                                <circle r="3" fill="currentColor" opacity="0.8">
                                    <animate attributeName="cx" from="0" to="16" dur="0.6s" repeatCount="indefinite"/>
                                    <animate attributeName="cy" values="4;4" dur="0.6s" repeatCount="indefinite"/>
                                </circle>
                            </pattern>
                            
                            <!-- Arrow markers -->
                            <marker id="arrowhead-yellow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#eab308"/>
                            </marker>
                            <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
                            </marker>
                            <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
                            </marker>
                            <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
                            </marker>
                        </defs>
                        
                        <!-- Static connection lines (always visible, dim) -->
                        <line x1="50%" y1="85" x2="20%" y2="200" stroke="#334155" stroke-width="2" stroke-dasharray="4,4"/>
                        <line x1="50%" y1="85" x2="50%" y2="200" stroke="#334155" stroke-width="2" stroke-dasharray="4,4"/>
                        <line x1="50%" y1="85" x2="80%" y2="200" stroke="#334155" stroke-width="2" stroke-dasharray="4,4"/>
                        <line x1="28%" y1="235" x2="42%" y2="235" stroke="#334155" stroke-width="2" stroke-dasharray="4,4"/>
                        <line x1="58%" y1="235" x2="72%" y2="235" stroke="#334155" stroke-width="2" stroke-dasharray="4,4"/>
                        
                        <!-- Active flow lines (shown/hidden based on power flow) -->
                        
                        <!-- Solar to Home -->
                        <g id="lineSolarHome" class="hidden">
                            <line x1="50%" y1="85" x2="50%" y2="195" stroke="#eab308" stroke-width="4" marker-end="url(#arrowhead-yellow)">
                                <animate attributeName="stroke-dasharray" values="0,1000;200,1000" dur="1s" fill="freeze"/>
                            </line>
                            <line x1="50%" y1="85" x2="50%" y2="195" stroke="#fde047" stroke-width="2" stroke-dasharray="8,12">
                                <animate attributeName="stroke-dashoffset" from="20" to="0" dur="0.5s" repeatCount="indefinite"/>
                            </line>
                        </g>
                        
                        <!-- Solar to Battery -->
                        <g id="lineSolarBattery" class="hidden">
                            <line x1="48%" y1="85" x2="23%" y2="195" stroke="#22c55e" stroke-width="4" marker-end="url(#arrowhead-green)">
                                <animate attributeName="stroke-dasharray" values="0,1000;200,1000" dur="1s" fill="freeze"/>
                            </line>
                            <line x1="48%" y1="85" x2="23%" y2="195" stroke="#4ade80" stroke-width="2" stroke-dasharray="8,12">
                                <animate attributeName="stroke-dashoffset" from="20" to="0" dur="0.5s" repeatCount="indefinite"/>
                            </line>
                        </g>
                        
                        <!-- Solar to Grid -->
                        <g id="lineSolarGrid" class="hidden">
                            <line x1="52%" y1="85" x2="77%" y2="195" stroke="#22c55e" stroke-width="4" marker-end="url(#arrowhead-green)">
                                <animate attributeName="stroke-dasharray" values="0,1000;200,1000" dur="1s" fill="freeze"/>
                            </line>
                            <line x1="52%" y1="85" x2="77%" y2="195" stroke="#4ade80" stroke-width="2" stroke-dasharray="8,12">
                                <animate attributeName="stroke-dashoffset" from="20" to="0" dur="0.5s" repeatCount="indefinite"/>
                            </line>
                        </g>
                        
                        <!-- Battery to Home -->
                        <g id="lineBatteryHome" class="hidden">
                            <line x1="28%" y1="230" x2="42%" y2="230" stroke="#22c55e" stroke-width="4" marker-end="url(#arrowhead-green)"/>
                            <line x1="28%" y1="230" x2="42%" y2="230" stroke="#4ade80" stroke-width="2" stroke-dasharray="6,8">
                                <animate attributeName="stroke-dashoffset" from="14" to="0" dur="0.4s" repeatCount="indefinite"/>
                            </line>
                        </g>
                        
                        <!-- Grid to Home (Import) -->
                        <g id="lineGridHome" class="hidden">
                            <line x1="72%" y1="230" x2="58%" y2="230" stroke="#ef4444" stroke-width="4" marker-end="url(#arrowhead-red)"/>
                            <line x1="72%" y1="230" x2="58%" y2="230" stroke="#f87171" stroke-width="2" stroke-dasharray="6,8">
                                <animate attributeName="stroke-dashoffset" from="14" to="0" dur="0.4s" repeatCount="indefinite"/>
                            </line>
                        </g>
                        
                        <!-- Home to Grid (Export) -->
                        <g id="lineHomeGrid" class="hidden">
                            <line x1="58%" y1="240" x2="72%" y2="240" stroke="#22c55e" stroke-width="4" marker-end="url(#arrowhead-green)"/>
                            <line x1="58%" y1="240" x2="72%" y2="240" stroke="#4ade80" stroke-width="2" stroke-dasharray="6,8">
                                <animate attributeName="stroke-dashoffset" from="14" to="0" dur="0.4s" repeatCount="indefinite"/>
                            </line>
                        </g>
                        
                        <!-- Grid to Battery (Grid Charging) -->
                        <g id="lineGridBattery" class="hidden">
                            <path d="M 72% 260 Q 50% 300 28% 260" fill="none" stroke="#ef4444" stroke-width="4" marker-end="url(#arrowhead-red)"/>
                            <path d="M 72% 260 Q 50% 300 28% 260" fill="none" stroke="#f87171" stroke-width="2" stroke-dasharray="6,8">
                                <animate attributeName="stroke-dashoffset" from="14" to="0" dur="0.4s" repeatCount="indefinite"/>
                            </path>
                        </g>
                    </svg>
                    
                    <!-- Icons Layer -->
                    <div class="absolute inset-0 flex flex-col items-center" style="z-index: 2;">
                        
                        <!-- Solar Panel - Top Center -->
                        <div class="flex flex-col items-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl flex items-center justify-center shadow-lg shadow-yellow-500/40 border-2 border-yellow-300/30">
                                <span class="text-3xl">‚òÄÔ∏è</span>
                            </div>
                            <div class="mt-2 text-xl font-bold text-yellow-400" id="flowPv">0 W</div>
                            <div class="text-xs text-slate-400 font-medium">SOLAR</div>
                        </div>
                        
                        <!-- Flow Values Row -->
                        <div class="flex justify-between w-full px-8 mb-4" style="max-width: 500px;">
                            <div id="valSolarBat" class="hidden text-center">
                                <span class="text-green-400 text-sm font-bold" id="flowValSolarBat">0W</span>
                            </div>
                            <div id="valSolarHome" class="hidden text-center">
                                <span class="text-yellow-400 text-sm font-bold" id="flowValSolarHome">0W</span>
                            </div>
                            <div id="valSolarGrid" class="hidden text-center">
                                <span class="text-green-400 text-sm font-bold" id="flowValSolarGrid">0W</span>
                            </div>
                        </div>
                        
                        <!-- Bottom Row: Battery, Home, Grid -->
                        <div class="flex justify-between items-start w-full px-4 mt-8" style="max-width: 600px;">
                            
                            <!-- Battery -->
                            <div class="flex flex-col items-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg shadow-green-500/40 border-2 border-green-400/30 relative overflow-hidden">
                                    <div id="batteryFill" class="absolute bottom-0 left-0 right-0 bg-green-400/50 transition-all duration-1000" style="height: 0%"></div>
                                    <span class="text-3xl relative z-10">üîã</span>
                                </div>
                                <div class="mt-2 text-lg font-bold text-green-400" id="flowBat">0 W</div>
                                <div class="text-xs text-slate-400 font-medium" id="flowBatLabel">BATTERY</div>
                                <div class="text-sm font-bold text-emerald-400 mt-1" id="flowSoc">0%</div>
                            </div>
                            
                            <!-- Battery-Home Flow Value -->
                            <div class="flex flex-col items-center justify-center h-20">
                                <div id="valBatHome" class="hidden">
                                    <span class="text-green-400 text-xs font-bold" id="flowValBatHome">0W</span>
                                </div>
                            </div>
                            
                            <!-- Home -->
                            <div class="flex flex-col items-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-500/40 border-2 border-purple-400/30">
                                    <span class="text-3xl">üè†</span>
                                </div>
                                <div class="mt-2 text-lg font-bold text-purple-400" id="flowLoad">0 W</div>
                                <div class="text-xs text-slate-400 font-medium">HOME</div>
                            </div>
                            
                            <!-- Home-Grid Flow Value -->
                            <div class="flex flex-col items-center justify-center h-20">
                                <div id="valGridHome" class="hidden">
                                    <span class="text-red-400 text-xs font-bold" id="flowValGridHome">0W</span>
                                </div>
                                <div id="valHomeGrid" class="hidden">
                                    <span class="text-green-400 text-xs font-bold" id="flowValHomeGrid">0W</span>
                                </div>
                            </div>
                            
                            <!-- Grid -->
                            <div class="flex flex-col items-center">
                                <div id="gridIcon" class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/40 border-2 border-blue-400/30">
                                    <span class="text-3xl">‚ö°</span>
                                </div>
                                <div class="mt-2 text-lg font-bold text-blue-400" id="flowGrid">0 W</div>
                                <div class="text-xs text-slate-400 font-medium" id="flowGridLabel">GRID</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="flex flex-wrap justify-center gap-4 mt-4 pt-4 border-t border-slate-700/50">
                    <div class="flex items-center gap-2 text-xs">
                        <div class="w-8 h-1 bg-yellow-400 rounded"></div>
                        <span class="text-slate-400">Solar Power</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        <div class="w-8 h-1 bg-green-400 rounded"></div>
                        <span class="text-slate-400">Export / Discharge</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        <div class="w-8 h-1 bg-red-400 rounded"></div>
                        <span class="text-slate-400">Import from Grid</span>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Today's Power Chart -->
                <div class="bg-slate-800/50 backdrop-blur-xl rounded-3xl p-6 border border-slate-700/50">
                    <h2 class="text-lg font-semibold mb-4">Power Flow (Solar, Load, Battery, Grid)</h2>
                    <div class="h-64">
                        <canvas id="powerChart"></canvas>
                    </div>
                </div>
                
                <!-- Energy Distribution -->
                <div class="bg-slate-800/50 backdrop-blur-xl rounded-3xl p-6 border border-slate-700/50">
                    <h2 class="text-lg font-semibold mb-4">Energy Distribution</h2>
                    <div class="h-64">
                        <canvas id="energyChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Energy Stats -->
            <div class="bg-slate-800/50 backdrop-blur-xl rounded-3xl p-6 border border-slate-700/50">
                <h2 class="text-lg font-semibold mb-4">Today's Energy Summary</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="energyStats"></div>
            </div>
            
            <!-- Battery SOC Chart -->
            <div class="bg-slate-800/50 backdrop-blur-xl rounded-3xl p-6 border border-slate-700/50">
                <h2 class="text-lg font-semibold mb-4">Battery State of Charge (24h)</h2>
                <div class="h-48">
                    <canvas id="socChart"></canvas>
                </div>
            </div>
            
            <!-- Recent Data Table -->
            <div class="bg-slate-800/50 backdrop-blur-xl rounded-3xl p-6 border border-slate-700/50">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Recent Readings</h2>
                    <span class="text-sm text-slate-400" id="lastUpdate">--</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-slate-400 text-sm border-b border-slate-700">
                                <th class="pb-3 font-medium">Time</th>
                                <th class="pb-3 font-medium text-right">Solar</th>
                                <th class="pb-3 font-medium text-right">Battery</th>
                                <th class="pb-3 font-medium text-right">Grid</th>
                                <th class="pb-3 font-medium text-right">Load</th>
                                <th class="pb-3 font-medium text-right">SOC</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="text-center text-slate-500 text-sm py-4">
                <p>Alpha ESS Solar Dashboard ‚Ä¢ Data updates every 5 minutes</p>
                <p class="mt-1">
                    <a href="https://docs.google.com/spreadsheets/d/1bOti4oyIAsbAFuj_8wooCvOp3ID3AbDLxxwJ9OwOnww/edit" 
                       target="_blank" class="text-green-400 hover:text-green-300">
                        üìä View Google Sheet Data
                    </a>
                </p>
            </footer>
        </main>
    </div>

    <script>
        // State
        let scriptUrl = '';
        let isDemo = false;
        let logs = [];
        let powerChart, energyChart, socChart;
        let historicalData = [];
        
        // Initialize
        window.onload = () => {
            const saved = localStorage.getItem('alpha_script_url');
            if (saved) document.getElementById('scriptUrl').value = saved;
        };
        
        function connect() {
            scriptUrl = document.getElementById('scriptUrl').value.trim();
            if (!scriptUrl) {
                alert('Please enter your Google Apps Script URL');
                return;
            }
            localStorage.setItem('alpha_script_url', scriptUrl);
            isDemo = false;
            showDashboard();
        }
        
        function startDemo() {
            isDemo = true;
            showDashboard();
            document.getElementById('systemId').textContent = 'üéÆ Demo Mode';
        }
        
        function showDashboard() {
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            initCharts();
            loadData();
            // Auto refresh every 30 minutes (1800000 ms)
            setInterval(loadData, 1800000);
        }
        
        // Initialize Charts
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#94a3b8', font: { family: 'Inter' } }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    }
                }
            };
            
            // Power Chart
            powerChart = new Chart(document.getElementById('powerChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Solar (kW)',
                            data: [],
                            borderColor: '#facc15',
                            backgroundColor: 'rgba(250, 204, 21, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Load (kW)',
                            data: [],
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Battery (kW)',
                            data: [],
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Grid (kW)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: chartOptions
            });
            
            // Energy Pie Chart
            energyChart = new Chart(document.getElementById('energyChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Solar', 'Grid Import', 'Battery Discharge'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#facc15', '#3b82f6', '#22c55e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#94a3b8', font: { family: 'Inter' } }
                        }
                    }
                }
            });
            
            // SOC Chart
            socChart = new Chart(document.getElementById('socChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Battery SOC (%)',
                        data: [],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Generate Demo Data
        function generateDemoData() {
            const now = new Date();
            const hour = now.getHours();
            const sunFactor = hour >= 6 && hour <= 18 ? Math.sin((hour - 6) * Math.PI / 12) : 0;
            
            // Generate historical data for charts
            const historical = [];
            for (let h = 0; h < 24; h++) {
                const sf = h >= 6 && h <= 18 ? Math.sin((h - 6) * Math.PI / 12) : 0;
                historical.push({
                    hour: h,
                    ppv: Math.round(sf * 5000 * (0.7 + Math.random() * 0.3)),
                    pload: Math.round(300 + Math.random() * 1500),
                    soc: Math.round(30 + sf * 50 + Math.random() * 20)
                });
            }
            
            return {
                success: true,
                data: {
                    systems: [{ sysSn: 'DEMO-SYSTEM-001' }],
                    realtime: {
                        ppv: Math.round(sunFactor * 5000 * (0.8 + Math.random() * 0.4)),
                        pbat: Math.round(-1500 + Math.random() * 3000),
                        soc: Math.round(40 + Math.random() * 50),
                        pgrid: Math.round(-1000 + Math.random() * 2000),
                        pload: Math.round(400 + Math.random() * 2000)
                    },
                    energy: {
                        epv: (5 + Math.random() * 35).toFixed(1),
                        eCharge: (2 + Math.random() * 8).toFixed(1),
                        eDischarge: (3 + Math.random() * 10).toFixed(1),
                        eInput: (0.5 + Math.random() * 3).toFixed(1),
                        eOutput: (2 + Math.random() * 8).toFixed(1),
                        eLoad: (8 + Math.random() * 15).toFixed(1)
                    },
                    historical: historical
                }
            };
        }
        
        // Load Data
        async function loadData() {
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                let result;
                let historyResult;
                
                if (isDemo) {
                    await new Promise(r => setTimeout(r, 800));
                    result = generateDemoData();
                    historyResult = { success: true, data: result.data.historical };
                } else {
                    // Get real-time data
                    console.log('Fetching real-time data...');
                    const response = await fetch(scriptUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'all' })
                    });
                    result = await response.json();
                    console.log('Real-time result:', result);
                    
                    // Get historical data from Google Sheets
                    console.log('Fetching historical data...');
                    const historyResponse = await fetch(scriptUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'history' })
                    });
                    historyResult = await historyResponse.json();
                    console.log('History result:', historyResult);
                    console.log('History records count:', historyResult.data ? historyResult.data.length : 0);
                }
                
                if (result && result.success) {
                    updateDashboard(result.data);
                    document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                }
                
                // Update charts with historical data
                if (historyResult && historyResult.success && historyResult.data && historyResult.data.length > 0) {
                    console.log('Updating charts with', historyResult.data.length, 'records');
                    console.log('First record:', historyResult.data[0]);
                    console.log('Last record:', historyResult.data[historyResult.data.length - 1]);
                    updateChartsWithHistory(historyResult.data);
                } else {
                    console.log('No historical data to display');
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
            
            document.getElementById('loading').classList.add('hidden');
        }
        
        // Update charts with historical data from Google Sheets
        function updateChartsWithHistory(history) {
            if (!history || history.length === 0) return;
            
            const labels = history.map(h => h.time);
            const pvData = history.map(h => h.ppv / 1000);
            const loadData = history.map(h => h.pload / 1000);
            const batData = history.map(h => h.pbat / 1000);
            const gridData = history.map(h => h.pgrid / 1000);
            const socData = history.map(h => h.soc);
            
            // Update Power Chart
            powerChart.data.labels = labels;
            powerChart.data.datasets[0].data = pvData;
            powerChart.data.datasets[1].data = loadData;
            powerChart.data.datasets[2].data = batData;
            powerChart.data.datasets[3].data = gridData;
            powerChart.update();
            
            // Update SOC Chart
            socChart.data.labels = labels;
            socChart.data.datasets[0].data = socData;
            socChart.update();
            
            // Update logs table with recent history
            logs = history.slice(-20).reverse().map(h => ({
                time: h.time,
                ppv: h.ppv,
                pbat: h.pbat,
                pgrid: h.pgrid,
                pload: h.pload,
                soc: h.soc
            }));
            updateTable();
        }
        
        // Update Dashboard
        function updateDashboard(data) {
            const r = data.realtime || {};
            const e = data.energy || {};
            
            // System ID
            if (data.systems?.[0]) {
                document.getElementById('systemId').textContent = data.systems[0].sysSn;
            }
            
            // Live Stats
            document.getElementById('pvPower').textContent = ((r.ppv || 0) / 1000).toFixed(2);
            document.getElementById('soc').textContent = (r.soc || 0) + '%';
            document.getElementById('loadPower').textContent = ((r.pload || 0) / 1000).toFixed(2);
            
            // Battery status
            const charging = (r.pbat || 0) < 0;
            document.getElementById('batStatus').textContent = 
                (charging ? '‚ö° Charging ' : 'üì§ Discharging ') + 
                Math.abs((r.pbat || 0) / 1000).toFixed(2) + ' kW';
            
            // Grid
            const exporting = (r.pgrid || 0) < 0;
            document.getElementById('gridPower').textContent = Math.abs((r.pgrid || 0) / 1000).toFixed(2);
            document.getElementById('gridStatus').textContent = exporting ? 'kW exporting' : 'kW importing';
            
            const gridCard = document.getElementById('gridCard');
            if (exporting) {
                gridCard.className = 'bg-gradient-to-br from-green-500/20 to-emerald-500/10 border border-green-500/30 rounded-2xl p-4 card-hover';
                document.getElementById('gridPower').className = 'text-3xl font-bold text-green-400';
                document.getElementById('gridStatus').className = 'text-green-400/60 text-sm';
            } else {
                gridCard.className = 'bg-gradient-to-br from-red-500/20 to-orange-500/10 border border-red-500/30 rounded-2xl p-4 card-hover';
                document.getElementById('gridPower').className = 'text-3xl font-bold text-red-400';
                document.getElementById('gridStatus').className = 'text-red-400/60 text-sm';
            }
            
            // Power Flow
            document.getElementById('flowPv').textContent = (r.ppv || 0) + ' W';
            document.getElementById('flowLoad').textContent = (r.pload || 0) + ' W';
            document.getElementById('flowBat').textContent = Math.abs(r.pbat || 0) + ' W';
            document.getElementById('flowBatLabel').textContent = charging ? 'Charging' : 'Discharging';
            document.getElementById('flowGrid').textContent = Math.abs(r.pgrid || 0) + ' W';
            document.getElementById('flowGrid').className = 'mt-2 text-lg font-bold ' + (exporting ? 'text-green-400' : 'text-red-400');
            document.getElementById('flowGridLabel').textContent = exporting ? 'Exporting' : 'Importing';
            document.getElementById('flowSoc').textContent = (r.soc || 0) + '%';
            
            // Battery fill
            document.getElementById('batteryFill').style.height = (r.soc || 0) + '%';
            
            // Grid icon color
            const gridIcon = document.getElementById('gridIcon');
            gridIcon.className = 'w-20 h-20 rounded-2xl flex items-center justify-center mx-auto shadow-lg ' + 
                (exporting ? 'bg-gradient-to-br from-green-500 to-emerald-600 shadow-green-500/30' : 'bg-gradient-to-br from-red-500 to-orange-600 shadow-red-500/30');
            
            // Update flow arrows based on power values
            updateFlowArrows(r.ppv || 0, r.pbat || 0, r.pgrid || 0, r.pload || 0);
            
            // Energy Stats
            const stats = [
                { label: 'Solar Generated', value: e.epv || 0, unit: 'kWh', icon: '‚òÄÔ∏è', color: 'yellow' },
                { label: 'Battery Charged', value: e.eCharge || 0, unit: 'kWh', icon: 'üîã', color: 'green' },
                { label: 'Battery Used', value: e.eDischarge || 0, unit: 'kWh', icon: 'üîã', color: 'orange' },
                { label: 'Grid Import', value: e.eInput || 0, unit: 'kWh', icon: '‚¨áÔ∏è', color: 'red' },
                { label: 'Grid Export', value: e.eOutput || 0, unit: 'kWh', icon: '‚¨ÜÔ∏è', color: 'green' },
                { label: 'Home Used', value: e.eLoad || 0, unit: 'kWh', icon: 'üè†', color: 'purple' }
            ];
            
            document.getElementById('energyStats').innerHTML = stats.map(s => `
                <div class="bg-slate-700/30 rounded-xl p-4 text-center">
                    <span class="text-2xl">${s.icon}</span>
                    <div class="text-2xl font-bold mt-2 text-${s.color}-400">${s.value}</div>
                    <div class="text-xs text-slate-400">${s.label}</div>
                </div>
            `).join('');
            
            // Update Charts
            if (data.historical) {
                updateCharts(data.historical, e);
            } else {
                // Use logged data for charts
                addToLog(r);
                updateChartsFromLogs(e);
            }
            
            // Energy Distribution Chart
            energyChart.data.datasets[0].data = [
                parseFloat(e.epv || 0),
                parseFloat(e.eInput || 0),
                parseFloat(e.eDischarge || 0)
            ];
            energyChart.update();
            
            // Data Table
            updateTable(r);
        }
        
        function addToLog(r) {
            logs.unshift({
                time: new Date().toLocaleTimeString(),
                ppv: r.ppv || 0,
                pbat: r.pbat || 0,
                pgrid: r.pgrid || 0,
                pload: r.pload || 0,
                soc: r.soc || 0
            });
            if (logs.length > 20) logs.pop();
        }
        
        function updateChartsFromLogs(e) {
            const labels = logs.map(l => l.time).reverse();
            const pvData = logs.map(l => l.ppv / 1000).reverse();
            const loadData = logs.map(l => l.pload / 1000).reverse();
            const batData = logs.map(l => l.pbat / 1000).reverse();
            const gridData = logs.map(l => l.pgrid / 1000).reverse();
            const socData = logs.map(l => l.soc).reverse();
            
            powerChart.data.labels = labels;
            powerChart.data.datasets[0].data = pvData;
            powerChart.data.datasets[1].data = loadData;
            powerChart.data.datasets[2].data = batData;
            powerChart.data.datasets[3].data = gridData;
            powerChart.update();
            
            socChart.data.labels = labels;
            socChart.data.datasets[0].data = socData;
            socChart.update();
        }
        
        function updateCharts(historical, e) {
            const labels = historical.map(h => h.hour + ':00');
            const pvData = historical.map(h => h.ppv / 1000);
            const loadData = historical.map(h => h.pload / 1000);
            const batData = historical.map(h => (h.pbat || 0) / 1000);
            const gridData = historical.map(h => (h.pgrid || 0) / 1000);
            const socData = historical.map(h => h.soc);
            
            powerChart.data.labels = labels;
            powerChart.data.datasets[0].data = pvData;
            powerChart.data.datasets[1].data = loadData;
            powerChart.data.datasets[2].data = batData;
            powerChart.data.datasets[3].data = gridData;
            powerChart.update();
            
            socChart.data.labels = labels;
            socChart.data.datasets[0].data = socData;
            socChart.update();
        }
        
        function updateTable() {
            document.getElementById('dataTable').innerHTML = logs.slice(0, 10).map(l => `
                <tr class="border-b border-slate-700/50">
                    <td class="py-3 text-slate-300">${l.time}</td>
                    <td class="py-3 text-right text-yellow-400">${(l.ppv / 1000).toFixed(2)} kW</td>
                    <td class="py-3 text-right ${l.pbat < 0 ? 'text-green-400' : 'text-orange-400'}">${(l.pbat / 1000).toFixed(2)} kW</td>
                    <td class="py-3 text-right ${l.pgrid < 0 ? 'text-green-400' : 'text-red-400'}">${(l.pgrid / 1000).toFixed(2)} kW</td>
                    <td class="py-3 text-right text-purple-400">${(l.pload / 1000).toFixed(2)} kW</td>
                    <td class="py-3 text-right">${l.soc}%</td>
                </tr>
            `).join('');
        }
        
        // Update flow arrows based on power values
        function updateFlowArrows(ppv, pbat, pgrid, pload) {
            // Hide all flow lines and values first
            const lines = ['lineSolarHome', 'lineSolarBattery', 'lineSolarGrid', 
                          'lineBatteryHome', 'lineGridHome', 'lineHomeGrid', 'lineGridBattery'];
            const vals = ['valSolarHome', 'valSolarBat', 'valSolarGrid', 
                         'valBatHome', 'valGridHome', 'valHomeGrid'];
            
            lines.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            vals.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            
            // Solar generating (ppv > 0)
            if (ppv > 50) {
                // Solar to Home (always when solar is generating and home is consuming)
                if (pload > 50) {
                    const solarToHome = Math.min(ppv, pload);
                    document.getElementById('lineSolarHome').classList.remove('hidden');
                    document.getElementById('valSolarHome').classList.remove('hidden');
                    document.getElementById('flowValSolarHome').textContent = solarToHome + 'W';
                }
                
                // Solar to Battery (battery is charging, pbat < 0)
                if (pbat < -50) {
                    document.getElementById('lineSolarBattery').classList.remove('hidden');
                    document.getElementById('valSolarBat').classList.remove('hidden');
                    document.getElementById('flowValSolarBat').textContent = Math.abs(pbat) + 'W';
                }
                
                // Solar to Grid (exporting, pgrid < 0)
                if (pgrid < -50) {
                    document.getElementById('lineSolarGrid').classList.remove('hidden');
                    document.getElementById('valSolarGrid').classList.remove('hidden');
                    document.getElementById('flowValSolarGrid').textContent = Math.abs(pgrid) + 'W';
                }
            }
            
            // Battery discharging to home (pbat > 0)
            if (pbat > 50) {
                document.getElementById('lineBatteryHome').classList.remove('hidden');
                document.getElementById('valBatHome').classList.remove('hidden');
                document.getElementById('flowValBatHome').textContent = pbat + 'W';
            }
            
            // Grid to Home (importing, pgrid > 0)
            if (pgrid > 50) {
                document.getElementById('lineGridHome').classList.remove('hidden');
                document.getElementById('valGridHome').classList.remove('hidden');
                document.getElementById('flowValGridHome').textContent = pgrid + 'W';
            }
            
            // Home to Grid (exporting without much solar - from battery)
            if (pgrid < -50 && ppv < 100) {
                document.getElementById('lineHomeGrid').classList.remove('hidden');
                document.getElementById('valHomeGrid').classList.remove('hidden');
                document.getElementById('flowValHomeGrid').textContent = Math.abs(pgrid) + 'W';
            }
            
            // Grid charging battery (rare - when grid charges battery at night)
            if (pbat < -50 && ppv < 100 && pgrid > 50) {
                document.getElementById('lineGridBattery').classList.remove('hidden');
            }
            
            // Update grid icon color based on import/export
            const gridIcon = document.getElementById('gridIcon');
            const exporting = pgrid < -50;
            if (exporting) {
                gridIcon.className = 'w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg shadow-green-500/40 border-2 border-green-400/30';
            } else if (pgrid > 50) {
                gridIcon.className = 'w-20 h-20 bg-gradient-to-br from-red-500 to-orange-600 rounded-2xl flex items-center justify-center shadow-lg shadow-red-500/40 border-2 border-red-400/30';
            } else {
                gridIcon.className = 'w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/40 border-2 border-blue-400/30';
            }
        }
        
        function showFlow(flowId, watts) {
            const el = document.getElementById(flowId);
            if (el) {
                el.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
