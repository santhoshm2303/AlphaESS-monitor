<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha ESS Battery Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">
    <div id="app" class="max-w-6xl mx-auto p-4">
        
        <!-- Loading -->
        <div id="loading" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 flex items-center gap-3">
                <svg class="animate-spin h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <span>Loading...</span>
            </div>
        </div>

        <!-- Setup Panel -->
        <div id="setupPanel" class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-2xl p-6 shadow-lg max-w-md w-full">
                <div class="flex items-center gap-3 mb-6">
                    <span class="text-2xl">üîã</span>
                    <h2 class="text-xl font-semibold text-slate-800">Alpha ESS Monitor</h2>
                </div>

                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                        <p class="font-medium mb-2">üìã Enter your Google Apps Script URL:</p>
                        <p class="text-xs">This is the URL you got after deploying your script.</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Google Apps Script URL</label>
                        <input type="text" id="scriptUrl" 
                               placeholder="https://script.google.com/macros/s/.../exec"
                               class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">App ID</label>
                        <input type="text" id="appId" placeholder="Your Alpha ESS App ID"
                               class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">App Secret</label>
                        <input type="password" id="appSecret" placeholder="Your Alpha ESS App Secret"
                               class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                    </div>

                    <button onclick="startMonitoring()"
                            class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        üöÄ Start Monitoring
                    </button>
                    
                    <button onclick="startDemo()"
                            class="w-full bg-slate-100 text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-200 transition-colors text-sm">
                        Try Demo Mode
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">üîã Alpha ESS Monitor</h1>
                    <p class="text-slate-500 text-sm" id="systemInfo">Loading...</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="fetchData()" id="refreshBtn"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        ‚Üª Refresh
                    </button>
                    <button onclick="showSetup()"
                            class="p-2 bg-slate-100 rounded-lg hover:bg-slate-200">‚öôÔ∏è</button>
                </div>
            </div>

            <!-- Error -->
            <div id="errorBox" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>
            
            <!-- Last Update -->
            <div id="lastUpdate" class="text-sm text-slate-500 mb-4"></div>

            <!-- Power Flow -->
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white mb-6">
                <h3 class="text-lg font-semibold mb-6 text-center">Live Power Flow</h3>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <!-- Solar -->
                    <div class="text-center">
                        <div class="bg-yellow-500/20 rounded-xl p-4">
                            <div class="text-3xl mb-2">‚òÄÔ∏è</div>
                            <div class="text-2xl font-bold text-yellow-400" id="pvPower">0.00</div>
                            <div class="text-xs text-slate-400">kW Solar</div>
                        </div>
                    </div>
                    <!-- Home + Battery -->
                    <div class="space-y-4">
                        <div class="bg-blue-500/20 rounded-xl p-4 text-center">
                            <div class="text-3xl mb-2">üè†</div>
                            <div class="text-2xl font-bold text-blue-400" id="loadPower">0.00</div>
                            <div class="text-xs text-slate-400">kW Load</div>
                        </div>
                        <div class="bg-green-500/20 rounded-xl p-4 text-center">
                            <div class="text-3xl mb-2">üîã</div>
                            <div class="text-2xl font-bold text-green-400" id="soc">0%</div>
                            <div class="text-sm" id="batStatus">--</div>
                            <div class="mt-2 w-full h-2 bg-slate-700 rounded-full">
                                <div id="socBar" class="h-full bg-green-500 rounded-full transition-all" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Grid -->
                    <div class="text-center">
                        <div id="gridBox" class="bg-red-500/20 rounded-xl p-4">
                            <div class="text-3xl mb-2">‚ö°</div>
                            <div class="text-2xl font-bold" id="gridPower">0.00</div>
                            <div class="text-xs text-slate-400" id="gridLabel">kW Grid</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Energy Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="energyStats"></div>

            <!-- Data Table -->
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <h3 class="font-semibold text-slate-800 mb-3">Session Log</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-3 py-2 text-left">Time</th>
                                <th class="px-3 py-2 text-right">Solar</th>
                                <th class="px-3 py-2 text-right">Battery</th>
                                <th class="px-3 py-2 text-right">Grid</th>
                                <th class="px-3 py-2 text-right">Load</th>
                                <th class="px-3 py-2 text-right">SOC</th>
                            </tr>
                        </thead>
                        <tbody id="logTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let config = { scriptUrl: '', appId: '', appSecret: '' };
        let isDemo = false;
        let logs = [];

        // Load saved config
        window.onload = function() {
            const saved = localStorage.getItem('alphaess_config');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('scriptUrl').value = config.scriptUrl || '';
                document.getElementById('appId').value = config.appId || '';
                document.getElementById('appSecret').value = config.appSecret || '';
            }
        };

        function showSetup() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('setupPanel').classList.remove('hidden');
        }

        function startDemo() {
            isDemo = true;
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('systemInfo').textContent = 'DEMO MODE';
            fetchData();
        }

        function startMonitoring() {
            config.scriptUrl = document.getElementById('scriptUrl').value.trim();
            config.appId = document.getElementById('appId').value.trim();
            config.appSecret = document.getElementById('appSecret').value.trim();

            if (!config.scriptUrl) {
                alert('Please enter your Google Apps Script URL');
                return;
            }
            if (!config.appId || !config.appSecret) {
                alert('Please enter your App ID and App Secret');
                return;
            }

            localStorage.setItem('alphaess_config', JSON.stringify(config));
            isDemo = false;
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            fetchData();
        }

        function generateDemoData() {
            const hour = new Date().getHours();
            const solar = hour >= 6 && hour <= 18 ? Math.sin((hour-6)*Math.PI/12) * 5000 : 0;
            return {
                success: true,
                data: {
                    systems: [{ sysSn: 'DEMO-001' }],
                    realtime: {
                        ppv: Math.round(solar * (0.8 + Math.random()*0.4)),
                        pbat: Math.round(-2000 + Math.random()*4000),
                        soc: Math.round(30 + Math.random()*50),
                        pgrid: Math.round(-1500 + Math.random()*3000),
                        pload: Math.round(500 + Math.random()*2000)
                    },
                    energy: {
                        epv: (5 + Math.random()*10).toFixed(1),
                        eCharge: (2 + Math.random()*5).toFixed(1),
                        eDischarge: (3 + Math.random()*6).toFixed(1),
                        eInput: (1 + Math.random()*3).toFixed(1),
                        eOutput: (2 + Math.random()*4).toFixed(1),
                        eLoad: (8 + Math.random()*8).toFixed(1)
                    }
                }
            };
        }

        async function fetchData() {
            showLoading(true);
            hideError();

            try {
                let result;
                
                if (isDemo) {
                    await new Promise(r => setTimeout(r, 500));
                    result = generateDemoData();
                } else {
                    // Use Google Apps Script with URL parameters (no CORS issues)
                    const url = new URL(config.scriptUrl);
                    
                    // Create a form and submit it via iframe to avoid CORS
                    result = await callGoogleScript(config.scriptUrl, {
                        action: 'all',
                        appId: config.appId,
                        appSecret: config.appSecret
                    });
                }

                if (result && result.success) {
                    updateDashboard(result.data);
                    addLog(result.data.realtime);
                    document.getElementById('lastUpdate').textContent = 
                        '‚úÖ Updated: ' + new Date().toLocaleTimeString();
                } else {
                    showError(result?.error || 'Failed to get data');
                }
            } catch (err) {
                showError('Error: ' + err.message);
            } finally {
                showLoading(false);
            }
        }

        // Call Google Apps Script using JSONP-style approach
        function callGoogleScript(url, data) {
            return new Promise((resolve, reject) => {
                // Create unique callback name
                const callbackName = 'callback_' + Date.now();
                
                // For Google Apps Script, we'll use fetch with no-cors and handle the response
                // But since that won't give us data, let's try a different approach
                
                // Actually, let's use the google.script.run style or just fetch
                fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(data)
                })
                .then(() => {
                    // no-cors doesn't return data, so we need another approach
                    // Let's try redirect method
                    return fetchViaForm(url, data);
                })
                .then(resolve)
                .catch(reject);
            });
        }

        // Fetch via hidden form/iframe approach
        function fetchViaForm(url, data) {
            return new Promise((resolve, reject) => {
                // For simplicity, let's use a GET request with URL params
                // This works better with Google Apps Script
                
                const params = new URLSearchParams();
                params.append('data', JSON.stringify(data));
                
                const fullUrl = url + '?data=' + encodeURIComponent(JSON.stringify(data));
                
                // Create script tag for JSONP-like behavior
                const script = document.createElement('script');
                const callbackName = 'jsonpCallback_' + Date.now();
                
                window[callbackName] = function(response) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(response);
                };
                
                // Actually, Google Apps Script doesn't support JSONP
                // Let's try opening in a new way using an iframe
                
                // Simplest: just use fetch and hope for the best
                fetch(url, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'text/plain'
                    }
                })
                .then(response => response.json())
                .then(resolve)
                .catch(reject);
            });
        }

        function updateDashboard(data) {
            if (data.systems && data.systems[0]) {
                document.getElementById('systemInfo').textContent = data.systems[0].sysSn;
            }

            if (data.realtime) {
                const r = data.realtime;
                document.getElementById('pvPower').textContent = (r.ppv/1000).toFixed(2);
                document.getElementById('loadPower').textContent = (r.pload/1000).toFixed(2);
                document.getElementById('soc').textContent = r.soc + '%';
                document.getElementById('socBar').style.width = r.soc + '%';
                
                const charging = r.pbat < 0;
                document.getElementById('batStatus').textContent = 
                    (charging ? '‚ö° Charging ' : 'üîã Discharging ') + Math.abs(r.pbat/1000).toFixed(2) + ' kW';
                document.getElementById('batStatus').className = 
                    'text-sm ' + (charging ? 'text-green-400' : 'text-orange-400');

                const exporting = r.pgrid < 0;
                document.getElementById('gridPower').textContent = Math.abs(r.pgrid/1000).toFixed(2);
                document.getElementById('gridPower').className = 
                    'text-2xl font-bold ' + (exporting ? 'text-green-400' : 'text-red-400');
                document.getElementById('gridLabel').textContent = 'kW ' + (exporting ? 'Export' : 'Import');
                document.getElementById('gridBox').className = 
                    (exporting ? 'bg-green-500/20' : 'bg-red-500/20') + ' rounded-xl p-4';
            }

            if (data.energy) {
                const e = data.energy;
                const stats = [
                    { label: 'Solar', value: e.epv || e.eToday || 0, icon: '‚òÄÔ∏è' },
                    { label: 'Bat In', value: e.eCharge || 0, icon: 'üîã' },
                    { label: 'Bat Out', value: e.eDischarge || 0, icon: 'üîã' },
                    { label: 'Grid In', value: e.eInput || 0, icon: '‚¨áÔ∏è' },
                    { label: 'Grid Out', value: e.eOutput || 0, icon: '‚¨ÜÔ∏è' },
                    { label: 'Load', value: e.eLoad || 0, icon: 'üè†' }
                ];
                document.getElementById('energyStats').innerHTML = stats.map(s => `
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="text-slate-500 text-sm">${s.icon} ${s.label}</div>
                        <div class="text-xl font-bold text-slate-800">${s.value} <span class="text-sm text-slate-400">kWh</span></div>
                    </div>
                `).join('');
            }
        }

        function addLog(realtime) {
            if (!realtime) return;
            logs.unshift({
                time: new Date().toLocaleTimeString(),
                ppv: realtime.ppv || 0,
                pbat: realtime.pbat || 0,
                pgrid: realtime.pgrid || 0,
                pload: realtime.pload || 0,
                soc: realtime.soc || 0
            });
            if (logs.length > 10) logs.pop();
            
            document.getElementById('logTable').innerHTML = logs.map(l => `
                <tr class="border-t">
                    <td class="px-3 py-2">${l.time}</td>
                    <td class="px-3 py-2 text-right text-yellow-600">${(l.ppv/1000).toFixed(2)}</td>
                    <td class="px-3 py-2 text-right ${l.pbat < 0 ? 'text-green-600' : 'text-orange-600'}">${(l.pbat/1000).toFixed(2)}</td>
                    <td class="px-3 py-2 text-right ${l.pgrid < 0 ? 'text-green-600' : 'text-red-600'}">${(l.pgrid/1000).toFixed(2)}</td>
                    <td class="px-3 py-2 text-right text-blue-600">${(l.pload/1000).toFixed(2)}</td>
                    <td class="px-3 py-2 text-right">${l.soc}%</td>
                </tr>
            `).join('');
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showError(msg) {
            const box = document.getElementById('errorBox');
            box.textContent = '‚ùå ' + msg;
            box.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorBox').classList.add('hidden');
        }
    </script>
</body>
</html>
